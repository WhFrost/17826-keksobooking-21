(()=>{"use strict";window.utils={createError:function(e){let t=document.createElement("div");t.style="position: fixed; width: 50%; top: 25%; z-index: 20; left: 0; right: 0; margin: 0 auto; text-align: center; padding: 20px;\n    font-size: 24px; background-color: white; border: 5px solid red; text-decoration: underline; text-decoration-color: red",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},window.backend={load:function(e,t,n,o,i){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){let e;switch(r.status){case 200:n(r.response);break;case 400:e="Неверный запрос";break;case 404:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+r.status+" "+r.statusText}e&&o(e)})),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o("Запрос не успел выполниться за "+r.timeout+"мс")})),r.timeout=1e3,r.open(e,t),r.send(i)},method:{GET:"GET",POST:"POST"},url:{DOWNLOAD:"https://21.javascript.pages.academy/keksobooking/data",UPLOAD:"https://21.javascript.pages.academy/keksobooking"}},(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".popup");window.card={filtersBlock:e,get:function(n){!function(){if(document.querySelector(".map__card"))return;let n=t.cloneNode(!0);window.map.block.insertBefore(n,e);const o=function(){let e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].classList.remove("map__pin--active");n.remove(),document.removeEventListener("keydown",i)},i=function(e){"Escape"===e.key&&(e.preventDefault(),o())};n.querySelector(".popup__close").addEventListener("click",(function(){o()})),document.addEventListener("keydown",i)}(),function(e){let t=document.querySelector(".popup__avatar");e.author.avatar?t.src=e.author.avatar:t.style.display="none"}(n),function(e){document.querySelector(".popup__title").textContent=e.offer.title}(n),function(e){let t=document.querySelector(".popup__text--address");e.offer.address?t.textContent=e.offer.address:t.style.display="none"}(n),function(e){document.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь"}(n),function(e){let t=document.querySelector(".popup__type");e.offer.type?t.textContent={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}[e.offer.type]:t.style.display="none"}(n),function(e){let t=document.querySelector(".popup__text--capacity");e.offer.rooms&&e.offer.guests?t.textContent=e.offer.rooms+" комнаты для "+e.offer.guests+" гостей":t.style.display="none"}(n),function(e){let t=document.querySelector(".popup__text--time");e.offer.checkin&&e.offer.checkout?t.textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout:t.style.display="none"}(n),function(e){let t=document.querySelector(".popup__features");for(;t.firstChild;)t.firstChild.remove();e.offer.features?e.offer.features.forEach((function(e){let n=document.createElement("li");n.classList.add("popup__feature"),n.classList.add("popup__feature--"+e),t.appendChild(n)})):t.style.display="none"}(n),function(e){let t=document.querySelector(".popup__description");e.offer.description?t.textContent=e.offer.description:t.style.display="none"}(n),function(e){let t=document.querySelector(".popup__photos");for(;t.firstChild;)t.firstChild.remove();e.offer.photos?e.offer.photos.forEach((function(e){let n=document.createElement("img");n.classList.add("popup__photo"),n.src=e,n.width=45,n.height=40,n.alt="Фотография жилья",t.appendChild(n)})):t.style.display="none"}(n)},remove:function(){let e=document.querySelector(".popup");e&&e.remove()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map").offsetWidth,n=document.querySelectorAll(".map__filter"),o=document.querySelector(".map__pin--main"),i=Math.round(32.5+o.offsetLeft),r=Math.round(32.5+o.offsetTop),a=Math.round(51.5),c=document.querySelector(".map__pins"),d=document.querySelector("#pin").content.querySelector(".map__pin"),u=function(){let e=c.querySelectorAll(".map__pin:not(.map__pin--main)");if(e)for(let t=0;t<e.length;t++)e[t].remove()},l=function(e){1!==e.which&&"Enter"!==e.key||(window.main.activate(),window.form.validate(),window.form.validatePrice(),window.form.validateRoom(),o.removeEventListener("mousedown",l),o.removeEventListener("keydown",l))},s=function(){o.addEventListener("mousedown",l),o.addEventListener("keydown",l)};s(),window.map={block:e,activate:function(){e.classList.remove("map--faded")},disable:function(){e.classList.add("map--faded"),u(),window.card.remove(),o.style="left: "+window.map.defaultMainPinX+"px;top: "+window.map.defaultMainPinY+"px;",s()},blockWidth:t,blockHeightMin:130,blockHeightMax:630,filters:n,mainPin:o,defaultMainPinX:570,defaultMainPinY:375,mainPinX:i,mainPinY:r,mainPinWidth:65,mainPinHeight:65,mainPinOffset:a,getPins:function(e){for(let t=0;t<window.data.offersCount;t++){let n=d.cloneNode(!0);c.appendChild(n),n.style.left=e[t].location.x+d.offsetWidth/2+"px",n.style.top=e[t].location.y+d.offsetHeight+"px",n.querySelector("img").src=e[t].author.avatar,n.querySelector("img").alt=e[t].offer.title}let t=c.querySelectorAll(".map__pin:not(.map__pin--main)");for(let n=0;n<window.data.offersCount;n++)t[n].addEventListener("click",(function(){for(let e=0;e<window.data.offersCount;e++)t[e].classList.contains("map__pin--active")&&t[e].classList.remove("map__pin--active");t[n].classList.add("map__pin--active"),window.card.get(e[n])}))},removePins:u}})(),(()=>{const e=window.card.filtersBlock.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),i=e.querySelector("#housing-guests"),r=e.querySelector("#housing-features");let a={onTypeChange:()=>{},onPriceChange:()=>{},onRoomsChange:()=>{},onGuestsChange:()=>{},onFeaturesChange:()=>{}};t.addEventListener("change",window.debounce((function(){let e=t.value;a.onTypeChange(e)}))),n.addEventListener("change",window.debounce((function(){let e=n.value;a.onPriceChange(e)}))),o.addEventListener("change",window.debounce((function(){let e=o.value;a.onRoomsChange(e)}))),i.addEventListener("change",window.debounce((function(){let e=i.value;a.onGuestsChange(e)}))),r.addEventListener("change",window.debounce((function(){let e=[],t=r.querySelectorAll("input:checked");for(let n=0;n<t.length;n++)e.push(t[n].value);a.onFeaturesChange(e)}))),window.filters={filtered:a,typeHandler:function(e){a.onTypeChange=e},priceHandler:function(e){a.onPriceChange=e},roomsHandler:function(e){a.onRoomsChange=e},guestsHandler:function(e){a.onGuestsChange=e},featuresHandler:function(e){a.onFeaturesChange=e}}})(),(()=>{let e=[],t=[],n="any",o="any",i="any",r="any",a=[];const c=function(e){let c=0;return e.offer.type!==n&&"any"!==n||(c+=1),function(e){switch(o){case"any":return e.offer.price>0;case"middle":return e.offer.price>=1e4&&e.offer.price<5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>=5e4}return!0}(e)&&(c+=1),e.offer.rooms!==Number(i)&&"any"!==i||(c+=1),e.offer.guests!==Number(r)&&"any"!==r||(c+=1),0===d(e.offer.features,a).length&&"any"!==a||(c+=t.length),c},d=function(e,n){return t=e.filter((e=>n.includes(e))),t},u=function(){window.map.removePins(),function(){const e=document.querySelector(".popup");e&&e.remove()}(),window.map.getPins(e.sort((function(e,t){let n=c(t)-c(e);return 0===n&&(n=function(e,t){return e.length>t.length?1:e.length<t.length?-1:0}(e.offer.features,t.offer.features)),n})))};window.filters.typeHandler((function(e){n=e,u()})),window.filters.priceHandler((function(e){o=e,u()})),window.filters.roomsHandler((function(e){i=e,u()})),window.filters.guestsHandler((function(e){r=e,u()})),window.filters.guestsHandler((function(e){r=e,u()})),window.filters.featuresHandler((function(e){a=e,u()})),window.data={offersCount:5,update:u,success:function(t){e=t,u()}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form__reset"),o=t.querySelectorAll("fieldset"),i=t.querySelector("#title"),r=t.querySelector("#address"),a=t.querySelector("#type"),c=t.querySelector("#price"),d={bungalow:0,flat:1e3,house:5e3,palace:1e4},u=t.querySelector("#timein"),l=t.querySelector("#timeout"),s=t.querySelector("#room_number"),f=t.querySelector("#capacity"),m=function(e){e.forEach((function(e){e.setAttribute("disabled",!0)}))},p=function(e){e.forEach((function(e){e.removeAttribute("disabled")}))},w=function(){c.placeholder=d[a.value],c.setAttribute("min",d[a.value])},y=function(e){e.forEach((function(e){e.removeAttribute("selected")}))},h=function(){100===Number(s.value)&&0!==Number(f.value)?f.setCustomValidity("Выбрано помещение не для гостей. Пожалуйста, измените свой выбор"):0===Number(f.value)&&100!==Number(s.value)?s.setCustomValidity("Выбрано помещение не для гостей. Пожалуйста, выберите максимальное кол-во комнат"):Number(s.value)<Number(f.value)?s.setCustomValidity("Слишком много гостей для этого помещения. Пожалуйста, выберите больше комнат"):(s.setCustomValidity(""),f.setCustomValidity(""))},v=function(){let t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.appendChild(t);const n=function(){t.remove(),window.preview.reset(),document.removeEventListener("keydown",o)},o=function(e){"Escape"===e.key&&(e.preventDefault(),n())};t.addEventListener("click",n),document.addEventListener("keydown",o),window.main.disable()},g=function(){let t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.appendChild(t);const n=function(){t.remove(),window.preview.reset(),document.removeEventListener("keydown",o)},o=function(e){"Escape"===e.key&&(e.preventDefault(),n())};t.querySelector(".error__button").addEventListener("click",n),t.addEventListener("click",n),document.addEventListener("keydown",o)},_=function(e){e.preventDefault(),window.preview.reset(),window.main.disable()},b=function(e){e.preventDefault(),window.backend.load(window.backend.method.POST,window.backend.url.UPLOAD,v,g,new FormData(t))};window.form={block:t,address:r,activate:function(){p(window.map.filters),p(o),t.classList.remove("ad-form--disabled"),r.value=window.map.mainPinX+", "+(window.map.mainPinY+window.map.mainPinOffset),r.setAttribute("readonly",!0)},disable:function(){m(window.map.filters),m(o),t.classList.add("ad-form--disabled"),t.reset(),r.value=window.map.mainPinX+", "+(window.map.mainPinY+window.map.mainPinOffset)},validate:function(){i.addEventListener("input",(function(){!function(){let e=i.value.length;0===e?i.setCustomValidity("Обязательное поле"):e<30?i.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?i.setCustomValidity("Удалите лишние "+(e-100)+" симв."):i.setCustomValidity("")}()})),c.addEventListener("input",(function(){c.value>1e6?c.setCustomValidity("Слишком большая стоимость"):c.setCustomValidity("")})),a.addEventListener("input",(function(){w()})),u.addEventListener("change",(function(){!function(){let e=l.querySelectorAll("option");y(e),e[u.selectedIndex].setAttribute("selected",!0)}()})),l.addEventListener("change",(function(){!function(){let e=u.querySelectorAll("option");y(e),e[l.selectedIndex].setAttribute("selected",!0)}()})),f.addEventListener("change",(function(){h()})),s.addEventListener("change",(function(){h()})),t.addEventListener("submit",b),n.addEventListener("click",_)},validateRoom:h,validatePrice:w,onSuccess:v,onError:g}})(),(()=>{const e=["jpg","jpeg","png"],t=window.form.block.querySelector(".ad-form-header__input"),n=window.form.block.querySelector(".ad-form-header__preview img"),o=window.form.block.querySelector(".ad-form__input"),i=window.form.block.querySelector(".ad-form__photo"),r=function(t,n){const o=t.target.files[0];if(o){const t=o.name.toLowerCase();if(e.some((function(e){return t.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){n.width=40,n.height=40,n.src=e.result})),e.readAsDataURL(o)}}};t.addEventListener("change",(function(e){r(e,n)})),o.addEventListener("change",(function(e){r(e,function(){const e=document.createElement("img");return e.style="width: 70px; height: 70px",i.appendChild(e)}())})),window.preview={reset:function(){for(n.src="img/muffin-grey.svg";i.firstChild;)i.firstChild.remove()}}})(),(()=>{const e=function(){window.map.disable(),window.form.disable()};e(),window.main={activate:function(){window.map.activate(),window.form.activate(),window.backend.load(window.backend.method.GET,window.backend.url.DOWNLOAD,window.data.success,window.utils.createError)},disable:e}})(),window.map.mainPin.addEventListener("mousedown",(function(e){let t=0-window.map.mainPinWidth/2,n=window.map.blockWidth-window.map.mainPinWidth/2,o=window.map.blockHeightMin-window.map.mainPinHeight,i=window.map.blockHeightMax-window.map.mainPinHeight;if(1===e.which){e.preventDefault();let r={x:e.clientX,y:e.clientY},a=function(e){e.preventDefault();let a=r.x-e.clientX,c=r.y-e.clientY;r={x:e.clientX,y:e.clientY};let d={x:window.map.mainPin.offsetLeft-a,y:window.map.mainPin.offsetTop-c};d.y<=o&&(d.y=o),d.y>=i&&(d.y=i),d.x<=t&&(d.x=t),d.x>=n&&(d.x=n),window.map.mainPin.style.top=d.y+"px",window.map.mainPin.style.left=d.x+"px",window.form.address.value=Math.floor(d.x+window.map.mainPinWidth/2)+", "+(d.y+window.map.mainPinHeight)},c=function(e){e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",c)}}))})();